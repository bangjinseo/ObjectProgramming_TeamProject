#include <SFML/Graphics.hpp>
#include <iostream>
#include <vector>
#include <string>
#include <locale>

std::wstring formatMoney(int money) {
    std::wstring result;
    std::wstring num = std::to_wstring(money);
    int count = 0;
    for (int i = num.size() - 1; i >= 0; --i) {
        result.insert(result.begin(), num[i]);
        count++;
        if (count % 3 == 0 && i != 0) {
            result.insert(result.begin(), L',');
        }
    }
    result += L"원";
    return result;
}

class MoneyDisplay {
private:
    int money = 0;
    sf::Text text;
    sf::Font font;

public:
    bool init() {
        if (!font.loadFromFile("NotoSansKR-SemiBold.ttf")) {
            std::cerr << "폰트 로딩 실패!" << std::endl;
            return false;
        }
        text.setFont(font);
        text.setCharacterSize(20);
        text.setFillColor(sf::Color::Yellow);
        text.setPosition(50.f, 30.f);
        text.setString(sf::String(formatMoney(money)));
        return true;
    }

    void increase() {
        money++;
        text.setString(sf::String(formatMoney(money)));
    }

    void draw(sf::RenderWindow& window) {
        window.draw(text);
    }
};

class Background {
private:
    sf::Texture texture;
    sf::Sprite sprite;
    std::string currentFile = "bg_playground.png";

public:
    bool init(const sf::RenderWindow& window) {
        return load("bg_playground.png", window);
    }

    bool load(const std::string& filename, const sf::RenderWindow& window) {
        if (!texture.loadFromFile(filename)) {
            std::cerr << filename << " 로딩 실패!" << std::endl;
            return false;
        }

        sprite.setTexture(texture);
        float scaleX = window.getSize().x / static_cast<float>(texture.getSize().x);
        float scaleY = window.getSize().y / static_cast<float>(texture.getSize().y);
        sprite.setScale(scaleX, scaleY);
        currentFile = filename;
        return true;
    }

    const std::string& getCurrentFile() const {
        return currentFile;
    }

    void draw(sf::RenderWindow& window) {
        window.draw(sprite);
    }
};

class Character {
private:
    std::vector<sf::Texture> textures;
    sf::Sprite sprite;
    int currentFrame = 0;
    sf::Clock clock;
    float switchTime = 0.5f;

public:
    bool init() {
        textures.resize(2);
        if (!textures[0].loadFromFile("kn_beggar1.png")) {
            std::cerr << "kn_beggar1.png 로딩 실패!" << std::endl;
            return false;
        }
        if (!textures[1].loadFromFile("kn_beggar2.png")) {
            std::cerr << "kn_beggar2.png 로딩 실패!" << std::endl;
            return false;
        }

        sprite.setTexture(textures[0]);
        sprite.setScale(0.6f, 0.6f);
        sprite.setPosition(20.f, 300.f);
        return true;
    }

    void update() {
        if (clock.getElapsedTime().asSeconds() >= switchTime) {
            currentFrame = (currentFrame + 1) % 2;
            sprite.setTexture(textures[currentFrame]);
            clock.restart();
        }
    }

    void draw(sf::RenderWindow& window) {
        window.draw(sprite);
    }
};

class Game {
private:
    sf::RenderWindow window;
    MoneyDisplay moneyDisplay;
    Background background;
    Character character;

    sf::Texture mjTexture;
    sf::Sprite mjSprite;
    bool showMyeongjun = false;

    sf::RectangleShape clickableArea;
    std::string lastScene = "bg_playground.png";

public:
    Game() : window(sf::VideoMode(405, 720), "Homeless Character Animation") {}

    bool init() {
        std::locale::global(std::locale(""));
        std::wcout.imbue(std::locale(""));

        if (!moneyDisplay.init() || !background.init(window) || !character.init())
            return false;

        clickableArea.setSize({ 180.f, 40.f });
        clickableArea.setPosition(203.f, 621.f);
        clickableArea.setOutlineColor(sf::Color::White);
        clickableArea.setOutlineThickness(2.f);

        if (!mjTexture.loadFromFile("명준.png")) {
            std::cerr << "명준.png 로딩 실패!" << std::endl;
        }
        else {
            mjSprite.setTexture(mjTexture);
            mjSprite.setScale(0.5f, 0.5f);
            mjSprite.setPosition(100.f, 400.f);
        }

        return true;
    }

    void run() {
        while (window.isOpen()) {
            handleEvents();
            update();
            render();
        }
    }

private:
    void handleEvents() {
        sf::Event event;
        while (window.pollEvent(event)) {
            if (event.type == sf::Event::Closed)
                window.close();

            if (event.type == sf::Event::KeyPressed && event.key.code == sf::Keyboard::Space) {
                moneyDisplay.increase();
            }

            if (event.type == sf::Event::MouseButtonPressed && event.mouseButton.button == sf::Mouse::Left) {
                sf::Vector2f mousePos = window.mapPixelToCoords({ event.mouseButton.x, event.mouseButton.y });
                std::wcout << L"[클릭 위치] x: " << static_cast<int>(mousePos.x) << L", y: " << static_cast<int>(mousePos.y) << std::endl;

                std::string current = background.getCurrentFile();
                if (current != "MovingBeggingPlace_bg.png" && current != "friends_bg.png") {
                    if (clickableArea.getGlobalBounds().contains(mousePos)) {
                        lastScene = current;
                        background.load("MovingBeggingPlace_bg.png", window);
                    }
                    else if (sf::FloatRect(13, 570, 181, 39).contains(mousePos)) {
                        lastScene = current;
                        background.load("friends_bg.png", window);
                    }
                    else if (sf::FloatRect(29, 294, 140, 45).contains(mousePos)) {
                        showMyeongjun = true;
                    }
                }
                else if (current == "MovingBeggingPlace_bg.png") {
                    if (sf::FloatRect(23, 159, 157, 189).contains(mousePos)) {
                        background.load("bg_playground.png", window);
                    }
                    else if (sf::FloatRect(209, 159, 155, 192).contains(mousePos)) {
                        background.load("bg_dujeongStaion.png", window);
                    }
                    else if (sf::FloatRect(24, 438, 157, 187).contains(mousePos)) {
                        background.load("bg_seouStation.png", window);
                    }
                    else if (sf::FloatRect(208, 436, 156, 185).contains(mousePos)) {
                        background.load("bg_google.png", window);
                    }
                    else if (sf::FloatRect(350, 92, 28, 23).contains(mousePos)) {
                        background.load(lastScene, window);
                    }
                }
                else if (current == "friends_bg.png") {
                    if (sf::FloatRect(352, 92, 27, 23).contains(mousePos)) {
                        background.load(lastScene, window);
                    }
                    else if (sf::FloatRect(29, 294, 140, 45).contains(mousePos)) {
                        showMyeongjun = true;
                    }
                }
            }
        }
    }

    void update() {
        std::string current = background.getCurrentFile();
        if (current != "MovingBeggingPlace_bg.png" && current != "friends_bg.png") {
            character.update();
        }
    }

    void render() {
        window.clear();
        background.draw(window);
        std::string current = background.getCurrentFile();
        if (current != "MovingBeggingPlace_bg.png" && current != "friends_bg.png") {
            character.draw(window);
        }
        if (current != "friends_bg.png" && current != "MovingBeggingPlace_bg.png" && showMyeongjun) {
            window.draw(mjSprite);
        }
        moneyDisplay.draw(window);
        window.display();
    }
};

int main() {
    Game game;
    if (!game.init())
        return -1;
    game.run();
    return 0;
}
