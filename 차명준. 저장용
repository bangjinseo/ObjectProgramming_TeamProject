#include <SFML/Graphics.hpp>
#include <iostream>
#include <vector>
#include <string>
#include <locale>

std::wstring formatMoney(int money) {
    std::wstring result;
    std::wstring num = std::to_wstring(money);
    int count = 0;
    for (int i = num.size() - 1; i >= 0; --i) {
        result.insert(result.begin(), num[i]);
        count++;
        if (count % 3 == 0 && i != 0) {
            result.insert(result.begin(), L',');
        }
    }
    result += L"원";
    return result;
}

class MoneyDisplay {
private:
    int money = 0;
    sf::Text text;
    sf::Font font;

public:
    bool init() {
        if (!font.loadFromFile("NotoSansKR-SemiBold.ttf")) {
            std::cerr << "폼트 로딩 실패!" << std::endl;
            return false;
        }
        text.setFont(font);
        text.setCharacterSize(20);
        text.setFillColor(sf::Color::Yellow);
        text.setPosition(50.f, 30.f);
        text.setString(sf::String(formatMoney(money)));
        return true;
    }

    void increase() {
        money++;
        text.setString(sf::String(formatMoney(money)));
    }

    void draw(sf::RenderWindow& window) {
        window.draw(text);
    }
};

class Background {
private:
    sf::Texture texture;
    sf::Sprite sprite;
    std::string currentFile = "bg_playground.png";

public:
    bool init(const sf::RenderWindow& window) {
        return load("bg_playground.png", window);
    }

    bool load(const std::string& filename, const sf::RenderWindow& window) {
        if (!texture.loadFromFile(filename)) {
            std::cerr << filename << " 로딩 실패!" << std::endl;
            return false;
        }

        sprite.setTexture(texture);
        float scaleX = window.getSize().x / static_cast<float>(texture.getSize().x);
        float scaleY = window.getSize().y / static_cast<float>(texture.getSize().y);
        sprite.setScale(scaleX, scaleY);
        currentFile = filename;
        return true;
    }

    const std::string& getCurrentFile() const {
        return currentFile;
    }

    void draw(sf::RenderWindow& window) {
        window.draw(sprite);
    }
};

class Character {
private:
    std::vector<sf::Texture> textures;
    sf::Sprite sprite;
    int currentFrame = 0;
    sf::Clock clock;
    float switchTime = 0.5f;

public:
    bool init() {
        textures.resize(2);
        if (!textures[0].loadFromFile("kn_beggar1.png")) return false;
        if (!textures[1].loadFromFile("kn_beggar2.png")) return false;

        sprite.setTexture(textures[0]);
        sprite.setScale(0.6f, 0.6f);
        sprite.setPosition(20.f, 300.f);
        return true;
    }

    void update() {
        if (clock.getElapsedTime().asSeconds() >= switchTime) {
            currentFrame = (currentFrame + 1) % 2;
            sprite.setTexture(textures[currentFrame]);
            clock.restart();
        }
    }

    void draw(sf::RenderWindow& window) {
        window.draw(sprite);
    }
};

class Game {
private:
    sf::RenderWindow window;
    MoneyDisplay moneyDisplay;
    Background background;
    Character character;

    sf::Texture mjTexture, ahTexture, jsTexture;
    sf::Sprite mjSprite, ahSprite, jsSprite;
    bool showMyeongjun = false, showAhyeon = false, showJinseo = false;

    sf::RectangleShape clickableArea;
    std::string lastScene = "bg_playground.png";

    sf::Font friendFont;
    sf::Text friendText1, friendText2, friendText3;

public:
    Game() : window(sf::VideoMode(405, 720), "Homeless Character Animation") {}

    bool init() {
        std::locale::global(std::locale(""));
        std::wcout.imbue(std::locale(""));

        if (!moneyDisplay.init() || !background.init(window) || !character.init()) return false;
        if (!friendFont.loadFromFile("NotoSansKR-SemiBold.ttf")) return false;

        friendText1.setFont(friendFont);
        friendText1.setString(L"친구하기");
        friendText1.setCharacterSize(28);
        friendText1.setFillColor(sf::Color::Black);
        sf::FloatRect rect1 = friendText1.getLocalBounds();
        friendText1.setOrigin(rect1.left + rect1.width / 2, rect1.top + rect1.height / 2);
        friendText1.setPosition(29.f + 70.f, 294.f + 21.5f);

        friendText2.setFont(friendFont);
        friendText2.setString(L"친구하기");
        friendText2.setCharacterSize(28);
        friendText2.setFillColor(sf::Color::Black);
        sf::FloatRect rect2 = friendText2.getLocalBounds();
        friendText2.setOrigin(rect2.left + rect2.width / 2, rect2.top + rect2.height / 2);
        friendText2.setPosition(221.f + 71.f, 292.f + 23.5f);

        friendText3.setFont(friendFont);
        friendText3.setString(L"친구하기");
        friendText3.setCharacterSize(28);
        friendText3.setFillColor(sf::Color::Black);
        sf::FloatRect rect3 = friendText3.getLocalBounds();
        friendText3.setOrigin(rect3.left + rect3.width / 2, rect3.top + rect3.height / 2);
        friendText3.setPosition(27.f + 70.5f, 496.f + 23.5f);

        clickableArea.setSize({ 180.f, 40.f });
        clickableArea.setPosition(203.f, 621.f);

        mjTexture.loadFromFile("friends_mj.png");
        ahTexture.loadFromFile("friends_ah.png");
        jsTexture.loadFromFile("friends_js.png");

        mjSprite.setTexture(mjTexture);
        ahSprite.setTexture(ahTexture);
        jsSprite.setTexture(jsTexture);

        mjSprite.setScale(0.5f, 0.5f);
        ahSprite.setScale(0.5f, 0.5f);
        jsSprite.setScale(0.5f, 0.5f);

        mjSprite.setPosition(100.f, 400.f);
        ahSprite.setPosition(220.f, 360.f);
        jsSprite.setPosition(160.f, 180.f);

        return true;
    }

    void run() {
        while (window.isOpen()) {
            handleEvents();
            update();
            render();
        }
    }

private:
    void handleEvents() {
        sf::Event event;
        while (window.pollEvent(event)) {
            if (event.type == sf::Event::Closed) window.close();

            if (event.type == sf::Event::KeyPressed && event.key.code == sf::Keyboard::Space)
                moneyDisplay.increase();

            if (event.type == sf::Event::MouseButtonPressed && event.mouseButton.button == sf::Mouse::Left) {
                sf::Vector2f mousePos = window.mapPixelToCoords({ event.mouseButton.x, event.mouseButton.y });
                std::wcout << L"[클릭 위치] x: " << (int)mousePos.x << L", y: " << (int)mousePos.y << std::endl;

                std::string current = background.getCurrentFile();

                if (current == "friends_bg.png") {
                    if (sf::FloatRect(29, 294, 140, 45).contains(mousePos)) {
                        friendText1.setString(L"내 친구");
                        showMyeongjun = true;
                    }
                    else if (sf::FloatRect(222, 292, 137, 46).contains(mousePos)) {
                        friendText2.setString(L"내 친구");
                        showAhyeon = true;
                    }
                    else if (sf::FloatRect(31, 496, 135, 45).contains(mousePos)) {
                        friendText3.setString(L"내 친구");
                        showJinseo = true;
                    }
                    else if (sf::FloatRect(354, 92, 27, 23).contains(mousePos)) {
                        background.load(lastScene, window);
                    }
                }

                if (current != "MovingBeggingPlace_bg.png" && current != "friends_bg.png") {
                    if (clickableArea.getGlobalBounds().contains(mousePos)) {
                        lastScene = current;
                        background.load("MovingBeggingPlace_bg.png", window);
                    }
                    else if (sf::FloatRect(13, 570, 181, 39).contains(mousePos)) {
                        lastScene = current;
                        background.load("friends_bg.png", window);
                    }
                }
                else if (current == "MovingBeggingPlace_bg.png") {
                    if (sf::FloatRect(23, 159, 157, 189).contains(mousePos))
                        background.load("bg_playground.png", window);
                    else if (sf::FloatRect(209, 159, 155, 192).contains(mousePos))
                        background.load("bg_dujeongStaion.png", window);
                    else if (sf::FloatRect(24, 438, 157, 187).contains(mousePos))
                        background.load("bg_seouStation.png", window);
                    else if (sf::FloatRect(208, 436, 156, 185).contains(mousePos))
                        background.load("bg_google.png", window);
                    else if (sf::FloatRect(354, 92, 27, 23).contains(mousePos))
                        background.load(lastScene, window);
                }
            }
        }
    }

    void update() {
        std::string current = background.getCurrentFile();
        if (current != "MovingBeggingPlace_bg.png" && current != "friends_bg.png")
            character.update();
    }

    void render() {
        window.clear();
        background.draw(window);

        std::string current = background.getCurrentFile();
        if (current != "MovingBeggingPlace_bg.png" && current != "friends_bg.png")
            character.draw(window);

        if ((current == "bg_playground.png" || current == "bg_dujeongStaion.png" || current == "bg_seouStation.png" || current == "bg_google.png")) {
            if (showMyeongjun) window.draw(mjSprite);
            if (showAhyeon) window.draw(ahSprite);
            if (showJinseo) window.draw(jsSprite);
        }

        if (current == "friends_bg.png") {
            window.draw(friendText1);
            window.draw(friendText2);
            window.draw(friendText3);
        }

        moneyDisplay.draw(window);
        window.display();
    }
};

int main() {
    Game game;
    if (!game.init()) return -1;
    game.run();
    return 0;
}
